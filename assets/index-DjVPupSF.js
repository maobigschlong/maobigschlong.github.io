var q=Object.defineProperty;var P=(a,e,t)=>e in a?q(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var o=(a,e,t)=>P(a,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class O{constructor(e,t){o(this,"canvas");o(this,"ctx");o(this,"characters",[]);o(this,"worker");o(this,"characterImages",{});o(this,"audioManager");o(this,"settings");o(this,"animationFrameId",0);o(this,"points",0);o(this,"isWindowFocused",!0);o(this,"isGameRunning",!1);o(this,"animateAll",()=>{this.isWindowFocused&&this.isGameRunning&&(this.worker.postMessage({type:"animate",time:performance.now()}),this.animationFrameId=requestAnimationFrame(this.animateAll))});this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.audioManager=e,this.settings=t.getSettings(),this.worker=new Worker(new URL("/assets/animation-worker-Dn1ckAW9.js",import.meta.url),{type:"module"}),this.loadCharacterImages(),this.setupEventListeners()}loadCharacterImages(){["luigi","mario","wario","yoshi"].forEach(e=>{const t=new Image;t.src=`img/character/${e}.png`,this.characterImages[e]=t})}setupEventListeners(){this.worker.onmessage||(this.worker.onmessage=this.handleWorkerMessage.bind(this)),this.canvas.removeEventListener("click",this.handleCanvasClick.bind(this)),this.canvas.addEventListener("click",this.handleCanvasClick.bind(this)),window.removeEventListener("focus",this.handleWindowFocus.bind(this)),window.removeEventListener("blur",this.handleWindowBlur.bind(this)),window.addEventListener("focus",this.handleWindowFocus.bind(this)),window.addEventListener("blur",this.handleWindowBlur.bind(this))}handleWorkerMessage(e){const{type:t,positions:s}=e.data;t==="update"&&(s.forEach((n,i)=>{this.characters[i]&&(this.characters[i].x=n.x,this.characters[i].y=n.y)}),this.drawCharacters())}drawCharacters(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.imageSmoothingEnabled=!1,this.characters.forEach(({img:e,x:t,y:s,width:n,height:i})=>{this.ctx.drawImage(e,t,s,n,i)})}addCharacter(e,t){const s=Math.random()*(this.canvas.width-e.width),n=Math.random()*(this.canvas.height-e.height),i=(Math.random()-.5)*this.settings.speed,r=(Math.random()-.5)*this.settings.speed;this.characters.push({img:this.characterImages[e.name],x:s,y:n,width:e.width,height:e.height}),t.push({x:s,y:n,dx:i,dy:r,width:e.width,height:e.height})}init(){this.canvas.width=960,this.canvas.height=540,this.canvas.style.width="100%",this.canvas.style.height="100%";const e=[{name:"luigi",width:60,height:77},this.settings.useMario&&{name:"mario",width:60,height:69},this.settings.useWario&&{name:"wario",width:60,height:64},this.settings.useYoshi&&{name:"yoshi",width:60,height:83}].filter(Boolean),t=this.settings.minIcons,s=this.settings.maxIcons,n=Math.floor(Math.random()*(s-t+1))+t,i=[];this.characters=[],this.addCharacter(e[0],i);for(let r=0;r<n;r++){let l=e[r%e.length];l.name==="luigi"&&(l=e[(r+1)%e.length]),this.addCharacter(l,i)}this.settings.shuffleCharacterLayers&&(this.characters=this.shuffleArray(this.characters)),this.worker.postMessage({type:"init",iconData:i,gameWidth:this.canvas.width,gameHeight:this.canvas.height,movementThreshold:this.settings.movementThreshold,useInterpolation:this.settings.useInterpolation}),this.isGameRunning=!0,this.animationFrameId=requestAnimationFrame(this.animateAll)}handleCanvasClick(e){const t=this.canvas.getBoundingClientRect(),s=this.canvas.width,n=this.canvas.height,i=Math.min(t.width/s,t.height/n),r=s*i,l=n*i,M=(t.width-r)/2,A=(t.height-l)/2,w=(e.clientX-t.left-M)/i,y=(e.clientY-t.top-A)/i;this.characters.forEach(({x:v,y:E,width:W,height:R,img:_})=>{w>=v&&w<=v+W&&y>=E&&y<=E+R&&_===this.characterImages.luigi&&this.isGameRunning&&(cancelAnimationFrame(this.animationFrameId),this.worker&&this.worker.terminate(),this.isGameRunning=!1,this.settings.SFX&&this.audioManager.playRandomCaughtSound(),this.points++,console.log("Points:",this.points),this.characters=this.characters.filter(N=>N.img===this.characterImages.luigi),this.drawCharacters(),setTimeout(()=>this.restartGame(),3e3))})}restartGame(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.worker=new Worker(new URL("/assets/animation-worker-Dn1ckAW9.js",import.meta.url),{type:"module"}),this.setupEventListeners(),this.init()}handleWindowFocus(){this.isWindowFocused=!0,this.isGameRunning&&(this.canvas.style.display="flex",document.getElementById("unfocusedNotice").style.display="none",this.worker.postMessage({type:"pause",paused:!1}),cancelAnimationFrame(this.animationFrameId),this.animationFrameId=requestAnimationFrame(this.animateAll))}handleWindowBlur(){this.isWindowFocused=!1,this.isGameRunning&&(this.canvas.style.display="none",document.getElementById("unfocusedNotice").style.display="block",this.worker.postMessage({type:"pause",paused:!0}))}shuffleArray(e){for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}}const g={useMario:!0,useWario:!0,useYoshi:!1,shuffleCharacterLayers:!0,useInterpolation:!1,showFPS:!0,music:!0,SFX:!0,movementThreshold:1,minIcons:50,maxIcons:100,speed:400};class G{constructor(e=localStorage){o(this,"settings");o(this,"inputElements");o(this,"speedLabel");this.storage=e,this.inputElements=this.getInputElements(),this.settings=this.loadSettings(),this.speedLabel=document.getElementById("speedFieldLabel"),this.applyUIValues(),this.setupEventListeners()}getInputElements(){return{useMario:document.getElementById("useMarioCheckbox"),useWario:document.getElementById("useWarioCheckbox"),useYoshi:document.getElementById("useYoshiCheckbox"),shuffleCharacterLayers:document.getElementById("shuffleLayersCheckbox"),useInterpolation:document.getElementById("useInterpolationCheckbox"),showFPS:document.getElementById("showFPSCheckbox"),music:document.getElementById("musicCheckbox"),SFX:document.getElementById("sfxCheckbox"),movementThreshold:document.getElementById("movementThresholdField"),minIcons:document.getElementById("minimumIconsField"),maxIcons:document.getElementById("maximumIconsField"),speed:document.getElementById("speedField")}}loadSettings(){return Object.fromEntries(Object.entries(g).map(([e,t])=>[e,this.getAndParseLocalStorage(e,typeof t=="boolean"?this.parseBoolean:parseInt,t)]))}applyUIValues(){Object.entries(this.inputElements).forEach(([e,t])=>{const s=e;typeof this.settings[s]=="boolean"?t.checked=this.settings[s]:t.value=this.settings[s].toString()}),this.updateSpeedLabel()}setupEventListeners(){this.inputElements.speed.addEventListener("input",()=>{this.updateSpeedLabel();const e=parseInt(this.inputElements.speed.value);isNaN(e)||(this.settings.speed=e)})}updateSpeedLabel(){this.speedLabel.childNodes[0].textContent=`Speed (value: ${this.inputElements.speed.value})`}setSetting(e,t){this.settings[e]=t}applySettings(){Object.entries(this.inputElements).forEach(([e,t])=>{const s=e;if(typeof g[s]=="boolean")this.setSetting(s,t.checked);else if(typeof g[s]=="number"){const n=parseInt(t.value,10);isNaN(n)||this.setSetting(s,n)}this.storage.setItem(s,this.settings[s].toString())}),window.location.reload()}getAndParseLocalStorage(e,t,s){const n=this.storage.getItem(e);return n!==null?t(n):s}parseBoolean(e){return(e==null?void 0:e.toString().toLowerCase())==="true"||e==="1"}getSettings(){return this.settings}}class j{constructor(){o(this,"audioContext");o(this,"audioBuffers",new Map);o(this,"playingSources",new Map);o(this,"gainNodes",new Map);o(this,"audioManifest",{music:{url:"audio/music.wav",loop:!0,volume:.6},luigi_caught_1:{url:"audio/luigi_caught_1.wav",volume:1},luigi_caught_2:{url:"audio/luigi_caught_2.wav",volume:1},luigi_caught_3:{url:"audio/luigi_caught_3.wav",volume:1}});this.audioContext=new AudioContext}async loadAll(){const e=Object.entries(this.audioManifest);for(const[t,s]of e)try{const i=await(await fetch(s.url)).arrayBuffer(),r=await this.audioContext.decodeAudioData(i);this.audioBuffers.set(t,r);const l=this.audioContext.createGain();l.gain.value=s.volume??1,l.connect(this.audioContext.destination),this.gainNodes.set(t,l)}catch(n){console.error(`Failed to load audio for key "${t}":`,n)}}async play(e){const t=this.audioBuffers.get(e),s=this.gainNodes.get(e);if(!t||!s)return console.warn(`Missing audio buffer or gain node for key "${e}".`),!1;this.audioContext.state==="suspended"&&await this.audioContext.resume();const n=this.audioContext.createBufferSource();return n.buffer=t,n.loop=this.audioManifest[e].loop??!1,n.connect(s),n.start(0),n.loop&&(this.stop(e),this.playingSources.set(e,n)),!0}stop(e){const t=this.playingSources.get(e);if(t){try{t.stop()}catch(s){console.warn(`Failed to stop audio for key "${e}":`,s)}this.playingSources.delete(e)}}mute(){this.audioContext.suspend()}unmute(){this.audioContext.resume()}setVolume(e,t){const s=this.gainNodes.get(e);s&&(s.gain.value=Math.max(0,Math.min(t,1)))}playRandomCaughtSound(){const e=["luigi_caught_1","luigi_caught_2","luigi_caught_3"],t=e[Math.floor(Math.random()*e.length)];this.play(t)}}const p=new G,d=new j,x=p.getSettings();let b,I;const c=document.getElementById("game"),u=document.getElementById("fullscreenButton"),S=document.getElementById("customAlertOverlay"),B=document.getElementById("customAlertText"),D=document.getElementById("customAlertClose");function T(a){B.textContent=a,S.style.display="flex",document.documentElement.style.overflow="hidden",document.body.style.overflow="hidden"}function Y(){S.style.display="none",B.textContent="",document.documentElement.style.overflow="",document.body.style.overflow=""}D.addEventListener("click",Y);window.addEventListener("load",async function(){c.offsetWidth,c.offsetHeight,await d.loadAll(),x.music||d.setVolume("music",0),document.querySelectorAll(".info-label .label-info-icon").forEach(e=>{const t=e;t.title&&t.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),T(t.title)})}),b=new O(d,p)});const h=[];let L;const f=document.getElementById("fpsCounter");function k(){requestAnimationFrame(()=>{const a=performance.now();for(;h.length>0&&h[0]<=a-1e3;)h.shift();h.push(a),L=h.length,k()})}setInterval(()=>{I=L,x.showFPS?(f.hidden=!1,f.textContent=`FPS: ${I}`):f.hidden=!0},1e3);k();function X(){document.fullscreenElement?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():c.requestFullscreen?c.requestFullscreen():c.mozRequestFullScreen?c.mozRequestFullScreen():c.webkitRequestFullscreen?c.webkitRequestFullscreen():c.msRequestFullscreen&&c.msRequestFullscreen()}function m(){document.fullscreenElement?u.textContent="Exit Fullscreen":u.textContent="Fullscreen"}u==null||u.addEventListener("click",X);document.addEventListener("fullscreenchange",m);document.addEventListener("webkitfullscreenchange",m);document.addEventListener("mozfullscreenchange",m);document.addEventListener("MSFullscreenChange",m);var C;(C=document.getElementById("startButton"))==null||C.addEventListener("click",()=>$());var F;(F=document.getElementById("applySettingsButton"))==null||F.addEventListener("click",()=>{p.applySettings()});async function $(){document.getElementById("startButton").style.visibility="hidden",await d.play("music")||console.warn("Music did not start"),b.init()}
